name: Claude Deep Research (Write Access)

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      research_topic:
        description: 'Topic to research'
        required: true
        type: string
      output_filename:
        description: 'Output markdown filename (without .md)'
        required: false
        default: 'research_report'
        type: string

jobs:
  claude-research:
    # Only trigger on @claude-research command from authorized users or manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        (
          github.event_name == 'issue_comment' ||
          github.event_name == 'pull_request_review_comment'
        ) &&
        contains(github.event.comment.body, '@claude-research') &&
        contains(fromJSON('["varunisrani"]'), github.event.comment.user.login)
      )

    runs-on: ubuntu-latest

    permissions:
      contents: write # Allow creating/editing files and committing
      pull-requests: write # Allow creating PRs
      issues: write # Allow commenting on issues
      id-token: write # Required for OIDC authentication
      actions: read # Read CI results

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better context

      - name: Extract research topic from comment
        id: extract-topic
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RESEARCH_TOPIC="${{ github.event.inputs.research_topic }}"
            OUTPUT_FILENAME="${{ github.event.inputs.output_filename }}"
          else
            # Extract everything after @claude-research
            COMMENT_BODY="${{ github.event.comment.body }}"
            RESEARCH_TOPIC=$(echo "$COMMENT_BODY" | sed -n 's/.*@claude-research\s*//p' | head -n 1)

            # Generate filename from topic (replace spaces with underscores, lowercase)
            OUTPUT_FILENAME=$(echo "$RESEARCH_TOPIC" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -cd '[:alnum:]_-' | cut -c1-50)

            if [ -z "$OUTPUT_FILENAME" ]; then
              OUTPUT_FILENAME="research_report_$(date +%Y%m%d_%H%M%S)"
            fi
          fi

          echo "topic=${RESEARCH_TOPIC}" >> $GITHUB_OUTPUT
          echo "filename=${OUTPUT_FILENAME}" >> $GITHUB_OUTPUT

          # Get issue/PR number if applicable
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request_review_comment" ]; then
            echo "issue_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

      - name: Load research instructions
        id: load-instructions
        run: |
          # Read the research prompt template
          INSTRUCTIONS=$(cat .github/research_prompt.md)

          # Use heredoc to preserve multiline content with context prepended
          echo "CUSTOM_INSTRUCTIONS<<EOF" >> $GITHUB_OUTPUT
          echo "# GitHub Context" >> $GITHUB_OUTPUT
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "- Research Topic: ${{ steps.extract-topic.outputs.topic }}" >> $GITHUB_OUTPUT
          echo "- Output Filename: ${{ steps.extract-topic.outputs.filename }}.md" >> $GITHUB_OUTPUT
          echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "- Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "# Your Research Task:" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "Research Topic: **${{ steps.extract-topic.outputs.topic }}**" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "Output File: \`research/${{ steps.extract-topic.outputs.filename }}.md\`" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "Please conduct thorough research using web searches and create a comprehensive markdown report." >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Deep Research
        id: claude
        uses: anthropics/claude-code-action@beta
        timeout-minutes: 45
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Custom trigger phrase for research workflow
          trigger_phrase: "@claude-research"

          # Research-specific instructions loaded from template
          custom_instructions: ${{ steps.load-instructions.outputs.CUSTOM_INSTRUCTIONS }}

          # Enable web search and file operations
          # allowed_tools: "WebSearch(*),WebFetch(*),Read(*),Write(*),Edit(*),Bash(mkdir *),Bash(ls *),Bash(cat *),Grep(*),Glob(*),TodoWrite(*)"

      - name: Commit research report
        if: success()
        run: |
          git config user.name "claude-research-bot"
          git config user.email "claude-research-bot@users.noreply.github.com"

          # Add any new files in research directory
          git add research/ || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Create commit message
            git commit -m "Research: ${{ steps.extract-topic.outputs.topic }}" \
              -m "Generated by Claude Deep Research" \
              -m "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" \
              -m "Topic: ${{ steps.extract-topic.outputs.topic }}" \
              -m "Output: research/${{ steps.extract-topic.outputs.filename }}.md"

            # Create a new branch for the research
            BRANCH_NAME="research/${{ steps.extract-topic.outputs.filename }}"
            git checkout -b "$BRANCH_NAME"
            git push -u origin "$BRANCH_NAME"

            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Research: ${{ steps.extract-topic.outputs.topic }}"
          branch: research/${{ steps.extract-topic.outputs.filename }}
          title: "Research Report: ${{ steps.extract-topic.outputs.topic }}"
          body: |
            ## Deep Research Report

            **Topic**: ${{ steps.extract-topic.outputs.topic }}

            **Generated by**: Claude Deep Research
            **Triggered by**: @${{ github.actor }}

            ### Report Location

            üìÑ `research/${{ steps.extract-topic.outputs.filename }}.md`

            ### Overview

            This PR contains a comprehensive research report generated by Claude using web search and analysis.

            ---

            ü§ñ Generated with Claude Deep Research
          labels: |
            research
            documentation
            automated

      - name: Comment on issue with results
        if: success() && steps.extract-topic.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.extract-topic.outputs.issue_number }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚úÖ **Research Complete!**

**Topic**: ${{ steps.extract-topic.outputs.topic }}

üìÑ **Report**: \`research/${{ steps.extract-topic.outputs.filename }}.md\`

A pull request has been created with the comprehensive research report. Check the PR for detailed findings and analysis.

ü§ñ Generated by Claude Deep Research`
            });

  unauthorized-message:
    # Post message for unauthorized users
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      contains(github.event.comment.body, '@claude-research') &&
      !contains(fromJSON('["varunisrani"]'), github.event.comment.user.login)

    runs-on: ubuntu-latest

    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Post unauthorized message
        uses: actions/github-script@v7
        with:
          script: |
            const comment = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå @${context.actor} - You are not authorized to trigger Claude research.

Only maintainers can trigger Claude research. Please ask a maintainer to run the research command.`
            };

            if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                ...comment,
                issue_number: context.issue.number
              });
            } else if (context.eventName === 'pull_request_review_comment') {
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: context.payload.comment.id,
                body: comment.body
              });
            }
